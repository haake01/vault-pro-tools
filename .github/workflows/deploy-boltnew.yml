name: ğŸš€ Deploy AutomÃ¡tico - Bolt.new SaaS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Clonar repositÃ³rio
        uses: actions/checkout@v3

      - name: âš™ï¸ Instalar dependÃªncias bÃ¡sicas
        run: |
          sudo apt-get update
          sudo apt-get install -y zip curl jq

      - name: ğŸ§  Preparar pacote do SaaS
        run: |
          mkdir -p build
          zip -r build/saas_package.zip . -x "*.git*" -x "*.github*"

      - name: ğŸ”‘ Configurar variÃ¡veis do Bolt.new
        env:
          BOLT_API_KEY: ${{ secrets.BOLT_API_KEY }}
          BOLT_PROJECT_ID: ${{ secrets.BOLT_PROJECT_ID }}
        run: |
          echo "ğŸ” Verificando chaves Bolt.new..."
          if [ -z "$BOLT_API_KEY" ] || [ -z "$BOLT_PROJECT_ID" ]; then
            echo "âŒ Falta API Key ou Project ID no GitHub Secrets"
            exit 1
          fi
          echo "âœ… Chaves OK"

      - name: ğŸ“¦ Enviar pacote para o Bolt.new
        run: |
          curl -X POST "https://api.bolt.new/v1/deploy" \
            -H "Authorization: Bearer $BOLT_API_KEY" \
            -F "project_id=$BOLT_PROJECT_ID" \
            -F "package=@build/saas_package.zip"

      - name: ğŸ§¾ Registrar build no Vault
        env:
          VAULT_API: ${{ secrets.VAULT_API }}
        run: |
          curl -X POST "$VAULT_API/logs" \
            -H "Content-Type: application/json" \
            -d "{\"event\":\"deploy_completed\",\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"branch\":\"main\"}"

      - name: âœ… FinalizaÃ§Ã£o
        run: echo "ğŸš€ Deploy concluÃ­do com sucesso para o Bolt.new!"
